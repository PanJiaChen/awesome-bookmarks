<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>升级篇 | awesome-bookmarks</title>
    <meta name="description" content="个人收藏夹">
    <link rel="icon" href="/awesome-bookmarks/favicon.ico">
    
    <link rel="preload" href="/awesome-bookmarks/assets/css/0.styles.ec76dc0b.css" as="style"><link rel="preload" href="/awesome-bookmarks/assets/js/app.87218aed.js" as="script"><link rel="preload" href="/awesome-bookmarks/assets/js/58.3a7aed53.js" as="script"><link rel="prefetch" href="/awesome-bookmarks/assets/js/10.13a04629.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/11.dfa445b3.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/12.252e1ea1.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/13.202eea2f.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/14.9a7f82ae.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/15.f30330ce.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/16.d8db4967.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/17.be2ef563.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/18.7f6a4069.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/19.e5c02e12.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/2.854dcf62.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/20.ed56267a.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/21.542fe49d.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/22.9aa62a89.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/23.62a907ea.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/24.6f88eaf3.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/25.884e6041.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/26.129b49e6.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/27.f099d417.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/28.24d3b4bf.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/29.27b8ad6a.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/3.8b2a45ed.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/30.8463898b.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/31.6cb40446.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/32.54e1e517.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/33.851b4496.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/34.b68f93f4.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/35.18beea4a.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/36.b349301f.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/37.73c16f79.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/38.f7c8eefe.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/39.89522232.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/4.c4f29f89.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/40.9278113b.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/41.777c3c6d.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/42.fb17c276.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/43.244e0c87.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/44.681de79b.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/45.f730c196.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/46.3375d240.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/47.a0544c28.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/48.40b5c1a1.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/49.15129fd2.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/5.7590f93c.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/50.858fcf01.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/51.93b531cb.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/52.aea4550c.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/53.07a0b368.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/54.4cfaeb40.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/55.276360c5.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/56.5615278a.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/57.fafe2582.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/59.5e8277d2.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/6.6174f641.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/60.ea7dff44.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/61.3277097f.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/62.34744d93.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/63.b8a7d3da.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/64.efd176ee.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/65.c6aa2b44.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/66.1b9ba254.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/67.b4fc8277.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/68.7a4c27e8.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/69.211d809b.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/7.f8530e59.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/70.03138361.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/71.4c0527c5.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/72.57bf41d7.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/73.ab67e2c0.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/74.093cb6a4.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/75.1e4daac6.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/76.79a45dda.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/77.0aa96205.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/78.d9ab8efc.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/79.9b9b3574.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/8.63235e5f.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/80.8c11dd18.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/81.7409aad7.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/82.c7ddff18.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/83.e913e2f9.js"><link rel="prefetch" href="/awesome-bookmarks/assets/js/9.7bffc828.js">
    <link rel="stylesheet" href="/awesome-bookmarks/assets/css/0.styles.ec76dc0b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/awesome-bookmarks/" class="home-link router-link-active"><!----> <span class="site-name">awesome-bookmarks</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/awesome-bookmarks/" class="nav-link">首页</a></div><div class="nav-item"><a href="/awesome-bookmarks/repository/" class="nav-link">库</a></div><div class="nav-item"><a href="/awesome-bookmarks/website/" class="nav-link">网站</a></div><div class="nav-item"><a href="/awesome-bookmarks/diary/read.html" class="nav-link">最近阅读</a></div><div class="nav-item"><a href="/awesome-bookmarks/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/awesome-bookmarks/interview/" class="nav-link">面试</a></div><div class="nav-item"><a href="/awesome-bookmarks/job/" class="nav-link">内推</a></div><div class="nav-item"><a href="/awesome-bookmarks/blog/" class="nav-link router-link-active">Blog</a></div> <a href="https://github.com/PanJiaChen/awesome-bookmarks" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/awesome-bookmarks/" class="nav-link">首页</a></div><div class="nav-item"><a href="/awesome-bookmarks/repository/" class="nav-link">库</a></div><div class="nav-item"><a href="/awesome-bookmarks/website/" class="nav-link">网站</a></div><div class="nav-item"><a href="/awesome-bookmarks/diary/read.html" class="nav-link">最近阅读</a></div><div class="nav-item"><a href="/awesome-bookmarks/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/awesome-bookmarks/interview/" class="nav-link">面试</a></div><div class="nav-item"><a href="/awesome-bookmarks/job/" class="nav-link">内推</a></div><div class="nav-item"><a href="/awesome-bookmarks/blog/" class="nav-link router-link-active">Blog</a></div> <a href="https://github.com/PanJiaChen/awesome-bookmarks" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Blog</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/awesome-bookmarks/blog/" aria-current="page" class="sidebar-link">前言</a></li><li><a href="/awesome-bookmarks/blog/cs.html" class="sidebar-link">CS</a></li><li><a href="/awesome-bookmarks/blog/es6.html" class="sidebar-link">ES6</a></li><li><a href="/awesome-bookmarks/blog/fe.html" class="sidebar-link">前端</a></li><li><a href="/awesome-bookmarks/blog/google-developer.html" class="sidebar-link">读谷歌开发指南</a></li><li><a href="/awesome-bookmarks/blog/js.html" class="sidebar-link">Javascript</a></li><li><a href="/awesome-bookmarks/blog/other.html" class="sidebar-link">Other</a></li><li><a href="/awesome-bookmarks/blog/performance .html" class="sidebar-link">前端性能监控</a></li><li><a href="/awesome-bookmarks/blog/product.html" class="sidebar-link">产品</a></li><li><a href="/awesome-bookmarks/blog/talk.html" class="sidebar-link">Talk</a></li><li><a href="/awesome-bookmarks/blog/typescript.html" class="sidebar-link">Ts</a></li><li><a href="/awesome-bookmarks/blog/vue.html" class="sidebar-link">Vue</a></li><li><a href="/awesome-bookmarks/blog/webpack.html" class="sidebar-link">Webpack</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><blockquote><p>本文作者来自 <a href="https://www.zhihu.com/org/hua-er-jie-jian-wen-ji-zhu-tuan-dui-92/activities" target="_blank" rel="noopener noreferrer">华尔街见闻技术团队<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> - <a href="https://github.com/PanJiaChen" target="_blank" rel="noopener noreferrer">花裤衩<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>前几天 webpack 作者 <a href="https://github.com/sokra" target="_blank" rel="noopener noreferrer">Tobias Koppers<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 发布了一篇新的文章 <a href="https://medium.com/webpack/webpack-4-0-to-4-16-did-you-know-71e25a57fa6b" target="_blank" rel="noopener noreferrer">webpack 4.0 to 4.16: Did you know?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>(需翻墙)，总结了一下<code>webpack 4</code>发布以来，做了哪些调整和优化。
并且说自己正在着手开发 <code>webpack 5</code>。</p> <blockquote><p>Oh you are still on webpack 3. I’m sorry, what is blocking you? We already working on webpack 5, so your stack might be outdated soon…</p></blockquote> <p>翻译成中文就是：</p> <p><img src="https://user-gold-cdn.xitu.io/2018/7/27/164db1a2e089c151?w=690&h=200&f=jpeg&s=22433" alt></p> <p>正好我也在使用一个文档生成工具 <a href="https://github.com/pedronauck/docz" target="_blank" rel="noopener noreferrer">docz<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>(安利一波) 也最低需要<code>webpack 4+</code>，新版<code>webpack</code>性能提高了不少，而且<code>webpack 4</code> 都已经发布五个多月了，想必应该已经没什么坑了，应该可以安心的按照别人写的升级攻略升级了。之前一直迟迟不升级完全是被去年被 <code>webpack 3</code> 坑怕了。它在 <code>code splitting</code> 的情况下 <code>CommonsChunkPlugin</code>会完全失效。过了好一段时间才修复，欲哭无泪。</p> <p>所以这次我等了快大半年才准备升级到<code>webpack 4</code> <strong>但万万没想到还是遇到了不少的问题！</strong> 有很多之前遗留的问题还是没有很好地解决。但最主要的问题还是它的文档有所欠缺，已经废除了的东西如<code>commonsChunkPlugin</code>还在官方文档中到处出现，很多重要的东西却一笔带过，甚至没写，需要用户自己去看源码才能解决。</p> <p>还比如在<code>v4.16.0</code>版本中废除了<code>optimization.occurrenceOrder</code>、<code>optimization.namedChunks</code>、<code>optimization.hashedModuleIds</code>、<code>optimization.namedModules</code> 这几个配置项，替换成了<code>optimization.moduleIds</code> 和 <code>optimization.chunkIds</code>，但文档完中全没有任何体现，所以你在新版本中还按照文档那样配置其实是没有任何效果的。</p> <p>最新最完整的文档还是看他项目的配置<a href="https://github.com/webpack/webpack/blob/master/schemas/WebpackOptions.json" target="_blank" rel="noopener noreferrer">WebpackOptions.json<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，强烈建议遇到不清楚的配置项可以看这个，因为它一定保证是和最新代码同步的。</p> <p>吐槽了这么多，我们言归正传。由于本次手摸手篇幅有些长，所以拆解成了上下两篇文章：</p> <ul><li>上篇 -- 就是普通的在<code>webpack 3</code>的基础上升级，要做哪些操作和遇到了哪些坑</li> <li>下篇 -- 是在<code>webpack 4</code>下怎么合理的打包和拆包，并且如何最大化利用 <code>long term caching</code></li></ul> <p><strong>本文章不是手摸手从零教你 webpack 配置，所以并不会讲太多很基础的配置问题</strong>。比如如何处理 css 文件，如何配置 webpack-dev-server，讲述 file-loader 和 url-loader 之间的区别等等，有需求的推荐看 <a href="https://webpack.js.org/concepts/" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或者 <a href="https://survivejs.com/webpack/developing/webpack-dev-server/" target="_blank" rel="noopener noreferrer">survivejs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 出的一个系列教程。或者推荐看我司的另一篇 wbepack 入门文章，已同步到 webpack4 <a href="https://github.com/wallstreetcn/webpack-and-spa-guide" target="_blank" rel="noopener noreferrer">传送门<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="升级篇"><a href="#升级篇" class="header-anchor">#</a> 升级篇</h2> <h3 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h3> <p>我一直认为模仿和借鉴是学习一个新东西最高效的方法。所以我建议还是通过借鉴一些成熟的 webpack 配置比较好。比如你项目是基于 react 生态圈的话可以借鉴 <a href="https://github.com/facebook/create-react-app" target="_blank" rel="noopener noreferrer">create-react-app<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ，下载之后<code>npm run eject</code> 就可以看到它详细的 webpack 配置了。vue 的话由于新版<code>vue cli</code>不支持 <code>eject</code>了，而且改用 <a href="https://github.com/mozilla-neutrino/webpack-chain" target="_blank" rel="noopener noreferrer">webpack-chain<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来配置，所以借鉴起来可能会不太方便，主要配置 <a href="https://github.com/vuejs/vue-cli/tree/dev/packages/@vue/cli-service/lib/config" target="_blank" rel="noopener noreferrer">地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。觉得麻烦的话你可以直接借鉴 <code>vue-element-admin</code> 的 <a href="https://github.com/PanJiaChen/vue-element-admin/pull/889" target="_blank" rel="noopener noreferrer">配置<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。或者你想自己发挥，你可以借鉴 webpack 官方的各种 <a href="https://github.com/webpack/webpack/tree/master/examples" target="_blank" rel="noopener noreferrer">examples<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，来组合你的配置。</p> <h3 id="升级-webpack"><a href="#升级-webpack" class="header-anchor">#</a> 升级 webpack</h3> <p>首先将 webpack 升级到 4 之后，直接运行<code>webpack --xxx</code>是不行的，因为新版本将命令行相关的东西单独拆了出去封装成了<code>webpack-cli</code>。会报如下错误：</p> <blockquote><p>The CLI moved into a separate package: webpack-cli.
Please install <code>webpack-cli</code> in addition to webpack itself to use the CLI.</p></blockquote> <p>所有你需要安装<code>npm install webpack-cli -D -S</code>。你也可将它安装在全局。</p> <p>同时新版 webpack 需要<code>Node.js 的最低支持版本为 6.11.5</code>不要忘了升级。如果还需要维护老项目可以使用 <a href="https://github.com/creationix/nvm" target="_blank" rel="noopener noreferrer">nvm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来做一下 node 版本管理。</p> <p><strong>升级所有依赖</strong></p> <p>因为<code>webpack4</code>改了 它的<code>hook</code> api ，所以所有的<code>loaders</code>、<code>plugins</code>都需要升级才能够适配。</p> <p>可以使用命令行 <code>npm outdated</code>，列出所以可以更新的包。免得再一个个去<code>npm</code>找相对于的可用版本了。</p> <p><img src="https://user-gold-cdn.xitu.io/2018/7/27/164da832e18a97ef?w=890&h=346&f=jpeg&s=105563" alt></p> <p>反正把<code>devDependencies</code>的依赖都升级一下，总归不会有错。</p> <h3 id="带来的变化"><a href="#带来的变化" class="header-anchor">#</a> 带来的变化</h3> <p>其实这次升级带来了不少改变，但大部分其实对于普通用户来说是不需要关注的，比如这次升级带来的功能<code>SideEffects</code>、<code>Module Type’s Introduced</code>、<code>WebAssembly Support</code>，基本平时是用不到的。我们主要关注那些对我们影响比较大的改动如：<code>optimization.splitChunks</code>代替原有的<code>CommonsChunkPlugin</code>(下篇文章会着重介绍)，和<code>Better Defaults-mode</code>更好的默认配置，这是大家稍微需要关注一下的。</p> <table><thead><tr><th style="text-align:left">废弃项</th> <th style="text-align:left">替代项(optimization)</th> <th style="text-align:center">主要功能</th></tr></thead> <tbody><tr><td style="text-align:left">UglifyjsWebpackPlugin</td> <td style="text-align:left">.minmize</td> <td style="text-align:center">压缩优化</td></tr> <tr><td style="text-align:left">ModuleConcatenationPlugin</td> <td style="text-align:left">.opconcatenateModules</td> <td style="text-align:center">Scope hoisting</td></tr> <tr><td style="text-align:left">CommonsChunkPlugin</td> <td style="text-align:left">.splitChunks/.runtimeChunk</td> <td style="text-align:center">Code splitting</td></tr> <tr><td style="text-align:left">NoEmitOnErrorsPlugin</td> <td style="text-align:left">noEmitOnErrors</td> <td style="text-align:center">编译出现错误，跳过输出阶段</td></tr></tbody></table> <blockquote><p>如果想进一步了解 <code>Tree Shaking</code>和<code>SideEffects</code>的可见文末拓展阅读。
<em>上图参考 <a href="https://zhuanlan.zhihu.com/p/35407642" target="_blank" rel="noopener noreferrer">Webpack 4 进阶<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></em></p></blockquote> <h3 id="默认配置"><a href="#默认配置" class="header-anchor">#</a> 默认配置</h3> <p>webpack 4 引入了<code>零配置</code>的概念，被 <a href="https://github.com/parcel-bundler/parcel" target="_blank" rel="noopener noreferrer">parcel<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 刺激到了。 不管效果怎样，这改变还是值得称赞的。</p> <blockquote><p>最近又新出了 <a href="http://fastpack.io/" target="_blank" rel="noopener noreferrer">Fastpack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 可以关注一下。</p></blockquote> <p>言归正题，我们来看看 webpack 默认帮我们做了些什么?</p> <p><code>development</code> 模式下，默认开启了<code>NamedChunksPlugin</code> 和<code>NamedModulesPlugin</code>方便调试，提供了更完整的错误信息，更快的重新编译的速度。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>module.exports = {
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> mode: 'development'
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> devtool: 'eval',
</span><span class="token prefix deleted">-</span><span class="token line"> plugins: [
</span><span class="token prefix deleted">-</span><span class="token line">   new webpack.NamedModulesPlugin(),
</span><span class="token prefix deleted">-</span><span class="token line">   new webpack.NamedChunksPlugin(),
</span><span class="token prefix deleted">-</span><span class="token line">   new webpack.DefinePlugin({ &quot;process.env.NODE_ENV&quot;: JSON.stringify(&quot;development&quot;) }),
</span><span class="token prefix deleted">-</span><span class="token line"> ]
</span></span>}
</code></pre></div><p><code>production</code> 模式下，由于提供了<code>splitChunks</code>和<code>minimize</code>，所以基本零配置，代码就会自动分割、压缩、优化，同时 webpack 也会自动帮你 <code>Scope hoisting</code> 和 <code>Tree-shaking</code>。</p> <div class="language-diff extra-class"><pre class="language-diff"><code>module.exports = {
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  mode: 'production',
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">  plugins: [
</span><span class="token prefix deleted">-</span><span class="token line">    new UglifyJsPlugin(/* ... */),
</span><span class="token prefix deleted">-</span><span class="token line">    new webpack.DefinePlugin({ &quot;process.env.NODE_ENV&quot;: JSON.stringify(&quot;production&quot;) }),
</span><span class="token prefix deleted">-</span><span class="token line">    new webpack.optimize.ModuleConcatenationPlugin(),
</span><span class="token prefix deleted">-</span><span class="token line">    new webpack.NoEmitOnErrorsPlugin()
</span><span class="token prefix deleted">-</span><span class="token line">  ]
</span></span>}
</code></pre></div><p>webpack 一直以来最饱受诟病的就是其配置门槛极高，配置内容极其复杂和繁琐，容易让人从入门到放弃，而它的后起之秀如 rollup、parcel 等均在配置流程上做了极大的优化，做到开箱即用，所以<code>webpack 4</code> 也从中借鉴了不少经验来提升自身的配置效率。<strong>愿世间再也不需要 webpack 配置工程师</strong>。</p> <h2 id="html-webpack-plugin"><a href="#html-webpack-plugin" class="header-anchor">#</a> html-webpack-plugin</h2> <p>用最新版本的的 <code>html-webpack-plugin</code>你可能还会遇到如下的错误：</p> <p><code>throw new Error('Cyclic dependency' + nodeRep)</code></p> <p>产生这个 bug 的原因是循环引用依赖，如果你没有这个问题可以忽略。</p> <p>目前解决方案可以使用 Alpha 版本，<code>npm i --save-dev html-webpack-plugin@next</code></p> <p>或者加入<code>chunksSortMode: 'none'</code>就可以了。</p> <p>但仔细查看文档发现设置成<code>chunksSortMode: 'none'</code>这样是会有问题的。</p> <blockquote><p>Allows to control how chunks should be sorted before they are included to the HTML.</p></blockquote> <p>这属性会决定你 chunks 的加载顺序，如果设置为<code>none</code>，你的 chunk 加载在页面中加载的顺序就不能够保证了，可能会出现样式被覆盖的情况。比如我在<code>app.css</code>里面修改了一个第三方库<code>element-ui</code>的样式，通过加载顺序的先后来覆盖它，但由于设置为了<code>none</code>，打包出来的结果变成了这样：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/app.8945fbfc.css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/chunk-elementUI.2db88087.css<span class="token punctuation">&quot;</span></span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p><code>app.css</code>被先加载了，之前写的样式覆盖就失效了，除非你使用<code>important</code>或者其它 css 权重的方式覆盖它，但这明显是不太合理的。
<code>vue-cli</code>正好也有这个相关 <a href="https://github.com/vuejs/vue-cli/issues/1978#issuecomment-409267484" target="_blank" rel="noopener noreferrer">issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，尤雨溪也在不使用<code>@next</code>版本的基础上 hack 了它，有兴趣的可以自己研究一下，本人在项目中直接使用了<code>@next</code>版本，也没遇到其它什么问题（除了不兼容 webpack 的 <code>prefetch/preload</code> 相关 <a href="https://github.com/jantimon/html-webpack-plugin/issues/934" target="_blank" rel="noopener noreferrer">issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。两种方案都可以，自行选择。</p> <p>其它 <code>html-webpack-plugin</code> 的配置和之前使用没有什么区别。</p> <h2 id="mini-css-extract-plugin"><a href="#mini-css-extract-plugin" class="header-anchor">#</a> mini-css-extract-plugin</h2> <h3 id="与-extract-text-webpack-plugin-区别"><a href="#与-extract-text-webpack-plugin-区别" class="header-anchor">#</a> 与 extract-text-webpack-plugin 区别</h3> <p>由于<code>webpack4</code>对 css 模块支持的完善以及在处理 css 文件提取的方式上也做了些调整，所以之前我们一直使用的<code>extract-text-webpack-plugin</code>也完成了它的历史使命，将让位于<code>mini-css-extract-plugin</code>。</p> <p>使用方式也很简单，大家看着 <a href="https://github.com/webpack-contrib/mini-css-extract-plugin#minimal-example" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 抄就可以了。</p> <p>它与<code>extract-text-webpack-plugin</code>最大的区别是：它在<code>code spliting</code>的时候会将原先内联写在每一个 js <code>chunk bundle</code>的 css，单独拆成了一个个 css 文件。</p> <p>原先 css 是这样内联在 js 文件里的：
<img src="https://user-gold-cdn.xitu.io/2018/7/24/164cb85b234d224a?w=2534&h=98&f=jpeg&s=50714" alt></p> <p>将 css 独立拆包最大的好处就是 js 和 css 的改动，不会影响对方。比如我改了 js 文件并不会导致 css 文件的缓存失效。而且现在它自动会配合<code>optimization.splitChunks</code>的配置，可以自定义拆分 css 文件，比如我单独配置了<code>element-ui</code>作为单独一个<code>bundle</code>,它会自动也将它的样式单独打包成一个 css 文件，不会像以前默认将第三方的 css 全部打包成一个几十甚至上百 KB 的<code>app.xxx.css</code>文件了。</p> <p><img src="https://user-gold-cdn.xitu.io/2018/7/24/164cbd49dc148656?w=516&h=254&f=png&s=73856" alt></p> <h3 id="压缩与优化"><a href="#压缩与优化" class="header-anchor">#</a> 压缩与优化</h3> <p>打包 css 之后查看源码，我们发现它并没有帮我们做代码压缩，这时候需要使用 <a href="https://github.com/NMFR/optimize-css-assets-webpack-plugin" target="_blank" rel="noopener noreferrer">optimize-css-assets-webpack-plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这个插件，它不仅能帮你压缩 css 还能优化你的代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//配置</span>
optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
  minimizer<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">OptimizeCSSAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://user-gold-cdn.xitu.io/2018/7/30/164e93dc299d7062?w=1778&h=764&f=jpeg&s=198182" alt></p> <p>如上图测试用例所示，由于<code>optimize-css-assets-webpack-plugin</code>这个插件默认使用了 <a href="https://github.com/cssnano/cssnano" target="_blank" rel="noopener noreferrer">cssnano<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来作 css 优化，
所以它不仅压缩了代码、删掉了代码中无用的注释、还去除了冗余的 css、优化了 css 的书写顺序，优化了你的代码 <code>margin: 10px 20px 10px 20px;</code> =&gt;<code>margin:10px 20px;</code>。同时大大减小了你 css 的文件大小。更多优化的细节见<a href="https://cssnano.co/guides/optimisations" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="contenthash"><a href="#contenthash" class="header-anchor">#</a> contenthash</h3> <p>但使用 <code>MiniCssExtractPlugin</code> 有一个需求特别注意的地方，在默认文档中它是这样配置的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// Options similar to the same options in webpackOptions.output</span>
  <span class="token comment">// both options are optional</span>
  filename<span class="token operator">:</span> devMode <span class="token operator">?</span> <span class="token string">'[name].css'</span> <span class="token operator">:</span> <span class="token string">'[name].[hash].css'</span><span class="token punctuation">,</span>
  chunkFilename<span class="token operator">:</span> devMode <span class="token operator">?</span> <span class="token string">'[id].css'</span> <span class="token operator">:</span> <span class="token string">'[id].[hash].css'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>简单说明一下： <code>filename</code> 是指在你入口文件<code>entry</code>中引入生成出来的文件名，而<code>chunkname</code>是指那些未被在入口文件<code>entry</code>引入，但又通过按需加载（异步）模块的时候引入的文件。</p></blockquote> <p>在 <strong>copy</strong> 如上代码使用之后发现情况不对！每次改动一个<code>xx.js</code>文件，它对应的 css 虽然没做任何改动，但它的 文件 hash 还是会发生变化。仔细对比发现原来是 <code>hash</code> 惹的祸。 <code>6.f3bfa3af.css</code> =&gt; <code>6.40bc56f6.css</code></p> <p><img src="https://user-gold-cdn.xitu.io/2018/7/24/164cbe27801ebf69?w=1214&h=308&f=png&s=162463" alt></p> <p>但我这是根据官方文档来写的！为什么还有问题！后来在文档的<strong>最最最</strong>下面发下了这么一段话！</p> <blockquote><p>For long term caching use filename: <code>[contenthash].css</code>. Optionally add [name].</p></blockquote> <p>非常的不理解，这么关键的一句话会放在 <code>Maintainers</code> 还后面的地方，默认写在配置里面提示大家不是更好？有热心群众已经开了一个<code>pr</code>，将文档默认配置为 <code>contenthash</code>。<code>chunkhash</code> =&gt; <code>contenthash</code>相关 <a href="https://github.com/webpack/webpack.js.org/issues/2096" target="_blank" rel="noopener noreferrer">issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>这个真的蛮过分的，稍不注意就会让自己的 css 文件缓存无效。而且很多用户平时修改代码的时候都不会在意自己最终打包出来的 <code>dist</code>文件夹中到底有哪些变化。所以这个问题可能就一直存在了。浪费了多少资源！人艰不拆！大家觉得 webpack 难用不是没道理的。</p> <h3 id="这里再简单说明一下几种-hash-的区别："><a href="#这里再简单说明一下几种-hash-的区别：" class="header-anchor">#</a> 这里再简单说明一下几种 hash 的区别：</h3> <ul><li><strong>hash</strong></li></ul> <p><code>hash</code> 和每次 <code>build</code>有关，没有任何改变的情况下，每次编译出来的 <code>hash</code>都是一样的，但当你改变了任何一点东西，它的<code>hash</code>就会发生改变。</p> <p>简单理解，你改了任何东西，<code>hash</code> 就会和上次不一样了。</p> <ul><li><strong>chunkhash</strong></li></ul> <p><code>chunkhash</code>是根据具体每一个模块文件自己的的内容包括它的依赖计算所得的<code>hash</code>，所以某个文件的改动只会影响它本身的<code>hash</code>，不会影响其它文件。</p> <ul><li><strong>contenthash</strong></li></ul> <p>它的出现主要是为了解决，让<code>css</code>文件不受<code>js</code>文件的影响。比如<code>foo.css</code>被<code>foo.js</code>引用了，所以它们共用相同的<code>chunkhash</code>值。但这样子是有问题的，如果<code>foo.js</code>修改了代码，<code>css</code>文件就算内容没有任何改变，由于是该模块的 <code>hash</code> 发生了改变，其<code>css</code>文件的<code>hash</code>也会随之改变。</p> <p>这个时候我们就可以使用<code>contenthash</code>了，保证即使<code>css</code>文件所处的模块里有任何内容的改变，只要 css 文件内容不变，那么它的<code>hash</code>就不会发生变化。</p> <p><code>contenthash</code> 你可以简单理解为是 <code>moduleId</code> + <code>content</code> 所生成的 <code>hash</code>。</p> <h2 id="热更新速度"><a href="#热更新速度" class="header-anchor">#</a> 热更新速度</h2> <p>其实相对 webpack 线上打包速度，我更关心的本地开发热更新速度，毕竟这才是和我们每一个程序员每天真正打交道的东西，打包一般都会扔给<code>CI</code>自动执行，而且一般项目每天也不会打包很多次。</p> <p><code>webpack 4</code>一直说自己更好的利用了<code>cache</code>提高了编译速度，但实测发现是有一定的提升，但当你一个项目，路由懒加载的页面多了之后，50+之后，热更新慢的问题会很明显，之前的<a href="https://juejin.im/post/595b4d776fb9a06bbe7dba56#heading-1" target="_blank" rel="noopener noreferrer">文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中也提到过这个问题，原以为新版本会解决这个问题，但并没有。</p> <p>不过你首先要排斥你的热更新慢不是，如：</p> <ul><li>没有使用合理的 <a href="https://webpack.js.org/configuration/devtool/#devtool" target="_blank" rel="noopener noreferrer">Devtool<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> souce map 导致</li> <li>没有正确使用 <a href="https://webpack.js.org/configuration/module/#rule-include" target="_blank" rel="noopener noreferrer">exclude/include<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 处理了不需要处理的如<code>node_modules</code></li> <li>在开发环境不要压缩代码<code>UglifyJs</code>、提取 css、babel polyfill、计算文件 hash 等不需要的操作</li></ul> <p><strong>旧方案</strong></p> <p>最早的方案是开发环境中不是用路由懒加载了，只在线上环境中使用。封装一个<code>_import</code>函数，通过环境变区分是否需要懒加载。</p> <p>开发环境：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@/views/'</span> <span class="token operator">+</span> file <span class="token operator">+</span> <span class="token string">'.vue'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
</code></pre></div><p>生成环境：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/'</span> <span class="token operator">+</span> file <span class="token operator">+</span> <span class="token string">'.vue'</span><span class="token punctuation">)</span>
</code></pre></div><p>但由于 webpack <code>import</code>实现机制问题，会产生一定的副作用。如上面的写法就会导致<code>@/views/</code>下的 所有<code>.vue</code> 文件都会被打包。不管你是否被依赖引用了，会多打包一些可能永远都用不到 js 代码。 <a href="https://github.com/PanJiaChen/vue-element-admin/issues/292" target="_blank" rel="noopener noreferrer">相关 issue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>目前新的解决方案思路还是一样的，只在生成模式中使用路由懒加载，本地开发不使用懒加载。但换了一种没副作用的实现方式。</p> <p><strong>新方案</strong></p> <p>使用<code>babel</code> 的 <code>plugins</code> <a href="https://github.com/airbnb/babel-plugin-dynamic-import-node" target="_blank" rel="noopener noreferrer">babel-plugin-dynamic-import-node<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。它只做一件事就是：将所有的<code>import()</code>转化为<code>require()</code>，这样就可以用这个插件将所有异步组件都用同步的方式引入了，并结合 <a href="https://babeljs.io/docs/usage/babelrc/#env-option" target="_blank" rel="noopener noreferrer">BABEL_ENV<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这个<code>bebel</code>环境变量，让它只作用于开发环境下。将开发环境中所有<code>import()</code>转化为<code>require()</code>，这种方案解决了之前重复打包的问题，同时对代码的侵入性也很小，你平时写路由的时候只需要按照官方<a href="https://router.vuejs.org/zh/guide/advanced/lazy-loading.html" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>路由懒加载的方式就可以了，其它的都交给<code>babel</code>来处理，当你不想用这个方案的时候，也只需要将它从<code>babel</code> 的 <code>plugins</code>中移除就可以了。</p> <p><strong>具体代码：</strong></p> <p>首先在<code>package.json</code>中增加<code>BABEL_ENV</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;BABEL_ENV=development webpack-dev-server XXXX&quot;</span>
</code></pre></div><p>接着在<code>.babelrc</code>只能加入<code>babel-plugin-dynamic-import-node</code>这个<code>plugins</code>，并让它只有在<code>development</code>模式中才生效。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;development&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;dynamic-import-node&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>之后就大功告成了，路由只要像平时一样写就可以了。<a href="https://panjiachen.github.io/vue-element-admin-site/zh/guide/advanced/lazy-loading.html#%E6%96%B0%E6%96%B9%E6%A1%88" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/login/index'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</code></pre></div><p>这样能大大提升你热更新的速度。基本两百加页面也能在<code>2000ms</code>的热跟新完成，基本做到无感刷新。当然你的项目本身就不大页面也不多，完全没必要搞这些。<strong>当你的页面变化跟不是你写代码速度的时候再考虑也不迟。</strong></p> <h2 id="打包速度"><a href="#打包速度" class="header-anchor">#</a> 打包速度</h2> <p><code>webpack 4</code> 在项目中实际测了下，普遍能提高 20%~30%的打包速度。</p> <p>本文不准备太深入的讲解这部分内容，详细的打包优化速度可以参考<a href="https://slack.engineering/keep-webpack-fast-a-field-guide-for-better-build-performance-f56a5995e8f1" target="_blank" rel="noopener noreferrer"> slack 团队的这篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，掘金还有<a href="https://github.com/xitu/gold-miner/blob/master/TODO/keep-webpack-fast-a-field-guide-for-better-build-performance.md" target="_blank" rel="noopener noreferrer">译文<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>这里有几个建议来帮你加速 webpack 的打包速度。</p> <p>首先你需要知道你目前打包慢，是慢在哪里。</p> <p>我们可以用 <a href="https://github.com/stephencookdev/speed-measure-webpack-plugin#readme" target="_blank" rel="noopener noreferrer">speed-measure-webpack-plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这个插件，它能监控 webpack 每一步操作的耗时。如下图：</p> <p><img src="https://user-gold-cdn.xitu.io/2018/7/31/164eee200ebc1911?w=554&h=492&f=jpeg&s=92342" alt></p> <p>可以看出其实大部分打包花费的时间是在<code>Uglifyjs</code>压缩代码。和前面的提升热更新的切入点差不多，查看<code>source map</code>的正确与否，<code>exclude/include</code>的正确使用等等。</p> <p>使用新版的<code>UglifyJsPlugin</code>的时候记住可以加上<code>cache: true</code>、<code>parall: true</code>，可以提搞代码打包压缩速度。更多配置可以参考 <a href="https://github.com/webpack-contrib/uglifyjs-webpack-plugin" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或者 vue-cli 的 <a href="https://github.com/vuejs/vue-cli/blob/dev/packages/@vue/cli-service/lib/config/uglifyOptions.js" target="_blank" rel="noopener noreferrer">配置<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>编译的时候还有还有一个很慢的原因是那些第三方库。比如<code>echarts</code>、<code>element-ui</code>其实都非常的大，比如<code>echarts</code>打包完也还有 775kb。所以你想大大提高编译速度，可以将这些第三方库 <code>externals</code> 出去，使用<code>script</code>的方式引入，或者使用 <code>dll</code>的方式打包。经测试一般如<code>echarts</code>这样大的包可以节省十几秒到几十秒不等。</p> <p>还有可以使用一些并行执行 webpack 的库：如<a href="https://github.com/trivago/parallel-webpack" target="_blank" rel="noopener noreferrer">parallel-webpack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>、<a href="https://github.com/amireh/happypack" target="_blank" rel="noopener noreferrer">happypack<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p><strong>顺便说一下，升级一下<code>node</code>可能有惊喜。前不久将<code>CI</code>里面的 node 版本依赖从 <code>6.9.2</code> =&gt; <code>8.11.3</code>，打包速度直接提升了一分多钟。</strong></p> <p>总之我觉得打包时间控制在差不多的范围内就可以了，没必要过分的优化。可能你研究了半天，改了一堆参数发现其实也就提升了几秒，但维护成本上去了，得不偿失。还不如升级 node、升级 webpack、升级你的编译环境的硬件水平来的实在和简单。</p> <p>比如我司<code>CI</code>使用的是腾讯云普通的的 8 核 16g 的机器，这个项目也是一个很大的后台管理项目 200+页面，引用了很多第三方的库，但没有使用什么<code>happypack</code>、<code>dll</code>，只是用了最新版的<code>webpack4</code>，<code>node@8.11.3</code>。
编译速度稳定在两分多钟，完全不觉得有什么要优化的必要。</p> <p><img src="https://user-gold-cdn.xitu.io/2018/7/29/164e5366dd1d9dec?w=896&h=236&f=jpeg&s=22563" alt></p> <h2 id="tree-shaking"><a href="#tree-shaking" class="header-anchor">#</a> Tree-Shaking</h2> <p>这其实并不是 webpack 4 才提出来的概念，最早是 <a href="https://github.com/rollup/rollup" target="_blank" rel="noopener noreferrer">rollup<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 提出来并实现的，后来在 webpack 2 中就实现了，本次在 webpack 4 只是增加了 <code>JSON Tree Shaking</code>和<code>sideEffects</code>能让你能更好的<strong>摇</strong>。</p> <p>不过这里还是要提一下，默认 webpack 是支持<code>Tree-Shaking</code>的，但在你的项目中可能会因为<code>babel</code>的原因导致它失效。</p> <p>因为<code>Tree Shaking</code>这个功能是基于<code>ES6 modules</code> 的静态特性检测，来找出未使用的代码，所以如果你使用了 babel 插件的时候，如：<a href="https://babeljs.io/docs/en/babel-preset-env/" target="_blank" rel="noopener noreferrer">babel-preset-env<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，它默认会将模块打包成<code>commonjs</code>，这样就会让<code>Tree Shaking</code>失效了。</p> <p>其实在 webpack 2 之后它自己就支持模块化处理。所以只要让 babel 不<code>transform modules</code>就可以了。配置如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// .babelrc</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      modules<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>顺便说一下都 8102 年了，请不要在使用<code>babel-preset-esxxxx</code>系列了，请用<code>babel-preset-env</code>，相关文章 <a href="https://zhuanlan.zhihu.com/p/29506685" target="_blank" rel="noopener noreferrer">再见，babel-preset-2015<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>拓展阅读：</p> <ul><li><a href="https://juejin.im/post/5b5d6d6f6fb9a04fea58aabc" target="_blank" rel="noopener noreferrer">手摸手，带你用合理的姿势使用 webpack4 （下）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/wallstreetcn/webpack-and-spa-guide" target="_blank" rel="noopener noreferrer">Webpack 4 和单页应用入门<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zhuanlan.zhihu.com/p/40052192" target="_blank" rel="noopener noreferrer">Webpack 中的 sideEffects 到底该怎么用？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zhuanlan.zhihu.com/p/32831172" target="_blank" rel="noopener noreferrer">你的 Tree-Shaking 并没什么卵用<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zhuanlan.zhihu.com/p/32148338" target="_blank" rel="noopener noreferrer">对 webpack 文档的吐槽<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zhuanlan.zhihu.com/p/32554436" target="_blank" rel="noopener noreferrer">Tree-Shaking 性能优化实践 - 原理篇<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://zhuanlan.zhihu.com/p/29506685" target="_blank" rel="noopener noreferrer">再见，babel-preset-2015<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/PanJiaChen/awesome-bookmarks/edit/master/docs/blog/webpack/webpack4-a.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">11/14/2019, 3:15:12 AM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/awesome-bookmarks/assets/js/app.87218aed.js" defer></script><script src="/awesome-bookmarks/assets/js/58.3a7aed53.js" defer></script>
  </body>
</html>
